language: rust

branches:
  except:
    - /^v\d+\.\d+\.\d+$/ # Exclude tags in the style of v1.2.3

cache:
  # https://levans.fr/rust_travis_cache.html
  directories:
    - $TRAVIS_HOME/.cargo/
    - $TRAVIS_HOME/.rustup/

matrix:
  allow_failures:
    - rust: nightly
  include:
    - name: "Linux Release Stable"
      os: linux
      rust: stable
      script: ["cargo test --verbose --release"]
    - name: "Linux Debug Stable"
      os: linux
      rust: stable
    - name: "Linux Debug Beta"
      os: linux
      rust: beta
    - name: "Linux Debug Nightly"
      os: linux
      rust: nightly
    - name: "Windows Debug Stable"
      os: windows
      rust: stable
    - name: "OS X Debug Stable"
      os: osx
      rust: stable
    - name: "iOS Debug Stable"
      os: osx
      rust: stable
      install:
        - rustup target install aarch64-apple-ios
      script:
        - cargo build --all --verbose --target=aarch64-apple-ios
    - name: "Android Debug Stable"
      os: linux
      dist: trusty
      language: android # https://docs.travis-ci.com/user/languages/android/
      android:
        components:
          #- tools
          #- platform-tools
          - build-tools-26.0.2
          - android-26
          - sys-img-x86-android-26 # for eventual unit testing via simulator
      install:
        - curl -sSf https://build.travis-ci.org/files/rustup-init.sh | sh -s -- --default-toolchain=stable -y
        - export PATH=${TRAVIS_HOME}/.cargo/bin:$PATH
        - echo y | sdkmanager "ndk-bundle"
        #- echo y | sdkmanager "lldb;3.1"
        - export PATH=/usr/local/android-sdk/ndk-bundle/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
        - export PATH=/usr/local/android-sdk/emulator:$PATH
        - rustup target install armv7-linux-androideabi
        - echo no | android create avd --force -n test -t android-26 --abi armeabi-v7a -c 100M
        - emulator -avd test -no-audio -no-window &
        - android-wait-for-emulator
        - adb shell input keyevent 82 &
      script:
        - pushd scripts/linux-android
        - cargo build --all --verbose --target=i686-linux-androideabi
        - popd
        - pushd target/i686-linux-android
        - export TEST_NAME=$(ls -t1 debug | grep 'bugsalot-' | head -n 1)
        - adb push $TEST_NAME /data/local/tmp/bugsalot_unit_tests
        - adb shell chmod 755 /data/local/tmp/bugsalot_unit_tests
        - adb shell /data/local/tmp/bugsalot_unit_tests
        - popd
    - name: "WASM Debug Stable"
      os: linux
      rust: stable
      install:
        - rustup target install wasm32-unknown-unknown
        - cargo-web --version || cargo install cargo-web
      script:
        - cargo web build --verbose --target=wasm32-unknown-unknown

script:
  - cargo test --verbose --all

before_cache:
  - rm -rf "$TRAVIS_HOME/.cargo/registry/src"
